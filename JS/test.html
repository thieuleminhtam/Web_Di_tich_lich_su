<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dẫn đường với Leaflet & Tìm kiếm</title>

    <!-- 1. Tải CSS của Leaflet và Plugin Routing Machine -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

    <style>
        /* CSS Reset & Font */
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            font-family: Arial, sans-serif;
            overflow: hidden; /* Tránh thanh cuộn không cần thiết */
        }

        /* Layout chính: Sidebar + Map */
        .container {
            display: flex;
            height: 100vh;
        }

        #sidebar {
            width: 350px;
            background-color: #f8f9fa;
            padding: 15px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            overflow-y: auto; /* Cho phép cuộn nếu nội dung quá dài */
            z-index: 1000;
        }

        #map {
            flex-grow: 1; /* Map sẽ chiếm hết phần còn lại */
            height: 100%;
        }

        /* Định dạng các thành phần trong Sidebar */
        #sidebar h1 {
            font-size: 18px;
            margin-top: 20px;
            margin-bottom: 10px;
            color: #333;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }

        .search-container {
            position: relative; /* Cần thiết cho việc định vị danh sách gợi ý */
        }

        #sidebar input[type="search"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
        }

        #sidebar button {
            width: 100%;
            padding: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }
        #sidebar button:hover {
            background-color: #0056b3;
        }

        .action-buttons {
            display: flex;
            gap: 10px; /* Tạo khoảng cách giữa các nút */
            margin-top: 20px;
        }
        .action-buttons button {
            background-color: #28a745; /* Green */
        }
        .action-buttons button.clear {
             background-color: #dc3545; /* Red */
        }
        .action-buttons button:hover {
             filter: brightness(90%);
        }

        /* Danh sách gợi ý tìm kiếm */
        .results-list {
            position: absolute;
            background-color: white;
            border: 1px solid #ddd;
            border-top: none;
            width: 100%;
            box-sizing: border-box;
            max-height: 200px;
            overflow-y: auto;
        }
        .results-list div {
            padding: 10px;
            cursor: pointer;
            font-size: 13px;
        }
        .results-list div:hover {
            background-color: #f2f2f2;
        }
        
        #status {
            margin-top: 20px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 4px;
            font-style: italic;
            color: #555;
            min-height: 50px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="sidebar">
            <h1>Tìm kiếm lộ trình</h1>
            
            <!-- Điểm bắt đầu -->
            <h1>Chọn điểm bắt đầu:</h1>
            <div class="search-container">
                <input type="search" id="start-input" placeholder="Nhập vị trí của bạn...">
                <div class="results-list" id="start-results"></div>
            </div>
            <button id="current-location-btn">Lấy vị trí hiện tại</button>

            <!-- Điểm kết thúc -->
            <h1>Chọn điểm đến:</h1>
            <div class="search-container">
                <input type="search" id="end-input" placeholder="Nhập điểm đến...">
                <div class="results-list" id="end-results"></div>
            </div>

            <!-- Nút hành động -->
            <div class="action-buttons">
                <button id="find-route-btn">Tìm đường</button>
                <button id="clear-btn" class="clear">Xóa Lộ Trình</button>
            </div>
            
             <!-- Hiển thị thông tin -->
            <div id="status">
                <p>Vui lòng chọn điểm bắt đầu và kết thúc.</p>
            </div>
        </div>

        <div id="map"></div>
    </div>

    <!-- 2. Tải JS của Leaflet và Plugin Routing Machine -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <script>
        // --- CÁC BIẾN TOÀN CỤC ---
        let map;
        let routingControl = null;
        let startMarker = null, endMarker = null;

        // --- ĐỊNH NGHĨA ICONS ---
        const icons = {
            start: L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            }),
            end: L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            }),
        };

        // --- KHỞI TẠO VÀ CÁC HÀM CHÍNH ---
        
        /** Hàm chính khởi tạo ứng dụng */
        function initializeApp() {
            initializeMap();
            setupEventListeners();
        }

        /** Khởi tạo bản đồ và các lớp bản đồ */
        function initializeMap() {
            map = L.map('map').setView([10.7769, 106.7009], 13); // Tọa độ trung tâm TP.HCM

            // Định nghĩa các lớp bản đồ nền
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map); // Thêm lớp OSM làm mặc định

            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            });

            const streetLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri'
            });

            const baseLayers = {
                'OpenStreetMap': osmLayer,
                'Bản đồ Vệ tinh': satelliteLayer,
                'Bản đồ Giao thông': streetLayer
            };

            // Thêm bộ điều khiển chọn lớp bản đồ
            L.control.layers(baseLayers, null, { position: 'topright', collapsed: true }).addTo(map);
        }

        /** Gắn các sự kiện cho các thành phần UI */
        function setupEventListeners() {
            // Lấy tham chiếu đến các element
            const startInput = document.getElementById('start-input');
            const endInput = document.getElementById('end-input');
            const startResults = document.getElementById('start-results');
            const endResults = document.getElementById('end-results');

            // Gắn sự kiện 'input' để tìm kiếm khi người dùng gõ
            startInput.addEventListener('input', debounce((e) => handleSearch(e.target.value, startResults, 'start', startInput), 300));
            endInput.addEventListener('input', debounce((e) => handleSearch(e.target.value, endResults, 'end', endInput), 300));
            
            // Gắn sự kiện cho các nút
            document.getElementById('current-location-btn').addEventListener('click', handleGeolocation);
            document.getElementById('find-route-btn').addEventListener('click', createOrUpdateRouting);
            document.getElementById('clear-btn').addEventListener('click', clearAll);

            // Click trên bản đồ để chọn điểm
            map.on('click', (e) => {
                if (!startMarker) {
                    setRoutePoint('start', e.latlng, "Vị trí trên bản đồ");
                } else if (!endMarker) {
                    setRoutepoint('end', e.latlng, "Vị trí trên bản đồ");
                }
            });
        }
        
        /** Hàm debounce để tránh gọi API liên tục */
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

   /*      *
         * Xử lý tìm kiếm địa điểm bằng Nominatim API
         * @param {string} query - Chuỗi tìm kiếm
         * @param {HTMLElement} resultsContainer - Element để hiển thị kết quả
         * @param {string} role - Vai trò của điểm ('start' hoặc 'end')
         * @param {HTMLInputElement} inputElement - Ô input tương ứng */
        
        async function handleSearch(query, resultsContainer, role, inputElement) {
            resultsContainer.innerHTML = '';
            if (query.length < 3) return;

            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=vn`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();

                data.forEach(place => {
                    const div = document.createElement('div');
                    div.textContent = place.display_name;
                    div.onclick = () => {
                        const latlng = L.latLng(place.lat, place.lon);
                        setRoutePoint(role, latlng, place.display_name);
                        inputElement.value = place.display_name;
                        resultsContainer.innerHTML = ''; // Xóa danh sách sau khi chọn
                    };
                    resultsContainer.appendChild(div);
                });
            } catch (error) {
                console.error("Lỗi khi tìm kiếm địa điểm:", error);
                updateStatus("Đã xảy ra lỗi khi tìm kiếm địa điểm.");
            }
        }

        /**
         * Đặt điểm bắt đầu hoặc kết thúc lên bản đồ
         * @param {string} role - 'start' hoặc 'end'
         * @param {L.LatLng} latlng - Tọa độ
         * @param {string} name - Tên địa điểm để hiển thị trong ô input
         */
        function setRoutePoint(role, latlng, name) {
            let marker;
            const icon = icons[role];

            if (role === 'start') {
                if (startMarker) map.removeLayer(startMarker);
                startMarker = L.marker(latlng, { icon, draggable: true }).addTo(map);
                marker = startMarker;
                document.getElementById('start-input').value = name;
            } else { // role === 'end'
                if (endMarker) map.removeLayer(endMarker);
                endMarker = L.marker(latlng, { icon, draggable: true }).addTo(map);
                marker = endMarker;
                document.getElementById('end-input').value = name;
            }
            
            // Cập nhật lại tọa độ nếu người dùng kéo thả marker
            marker.on('dragend', () => {
                const newLatLng = marker.getLatLng();
                const inputElement = (role === 'start') ? document.getElementById('start-input') : document.getElementById('end-input');
                inputElement.value = `(${newLatLng.lat.toFixed(5)}, ${newLatLng.lng.toFixed(5)})`;
                createOrUpdateRouting();
            });
            
            updateStatus("Đã chọn điểm. Sẵn sàng tìm đường.");
        }

        /** Tạo hoặc cập nhật lộ trình */
        function createOrUpdateRouting() {
            if (!startMarker || !endMarker) {
                updateStatus("Vui lòng chọn đủ cả điểm bắt đầu và kết thúc.");
                return;
            }

            const waypoints = [startMarker.getLatLng(), endMarker.getLatLng()];
            
            if (routingControl) {
                routingControl.setWaypoints(waypoints);
            } else {
                routingControl = L.Routing.control({
                    waypoints: waypoints,
                    routeWhileDragging: true,
                    show: true,
                    addWaypoints: false,
                    createMarker: () => null // Không tạo marker mặc định A, B
                }).addTo(map);
            }

            routingControl.on('routesfound', (e) => {
                const route = e.routes[0];
                const distance = (route.summary.totalDistance / 1000).toFixed(2);
                const time = new Date(route.summary.totalTime * 1000).toISOString().substr(11, 8);
                updateStatus(`<b>Tìm thấy lộ trình!</b><br>Khoảng cách: ${distance} km<br>Thời gian dự kiến: ${time}`);
            });
        }
        
        /** Xử lý lấy vị trí hiện tại của người dùng */
        function handleGeolocation() {
            map.locate({ setView: true, maxZoom: 16 });
            updateStatus("Đang xác định vị trí của bạn...");

            map.once('locationfound', (e) => {
                setRoutePoint('start', e.latlng, "Vị trí của bạn");
                L.circle(e.latlng, e.accuracy).addTo(map); // Vòng tròn thể hiện độ chính xác
                updateStatus("Đã tìm thấy vị trí của bạn. Vui lòng chọn điểm đến.");
            });

            map.once('locationerror', (e) => {
                alert(e.message);
                updateStatus("Lỗi khi lấy vị trí.");
            });
        }

        /** Xóa toàn bộ lộ trình và marker để làm lại */
        function clearAll() {
            if (routingControl) {
                map.removeControl(routingControl);
                routingControl = null;
            }
            if (startMarker) map.removeLayer(startMarker);
            if (endMarker) map.removeLayer(endMarker);

            startMarker = null;
            endMarker = null;
            
            document.getElementById('start-input').value = '';
            document.getElementById('end-input').value = '';
            
            updateStatus("Vui lòng chọn điểm bắt đầu và kết thúc.");
        }
        
        /** Cập nhật thông tin trạng thái cho người dùng */
        function updateStatus(message) {
            document.getElementById('status').innerHTML = message;
        }

        // --- KHỞI CHẠY ỨNG DỤNG ---
        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>
</html>